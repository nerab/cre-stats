#!/usr/bin/env ruby

require 'bundler'
Bundler.require

require 'jbuilder'

include CRE::Stats
cre_fetcher = Fetcher.new
episodes = Episodes.new(cre_fetcher)
#comments = CRE::Stats::Comments.new(cre_fetcher)

STDERR.puts "Number of episodes (#{episodes.all.count} overall) distributed over the years:"

result = Jbuilder.encode do |json|
  json.created_at DateTime.now

  json.series episodes.all.group_by{|e| e.released_at.year}.inject([]) do |line, a|
    line << [a.first, a.last.size, Duration.new(a.last.inject(0){|sum, e| sum + e.duration})]
  end
end

puts result
